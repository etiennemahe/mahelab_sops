<!DOCTYPE html>
<html lang="en">
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link rel="stylesheet" href="mahe-lab_style.css">
		<title>MAHELAB Standard Operating Procedure</title>
	</head>
	<body>
		<div>
			<h1>MAHELAB Standard Operating Procedure</h1>
			<table id="protocol">
				<!-- two column table -->
				<tr><td> </td><td> </td></tr>
			</table>
			<br><br>
		</div>
		<div>
			<h2><img src="https://github.githubassets.com/images/icons/emoji/unicode/26d4.png?v8" width="20"/> Authorization</h2>
			<table id="authorization">
				<!-- one column table -->
				<tr><td> </td></tr>
			</table>
			<br><br>
		</div>
		<div>
			<h2><img src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png?v8" width="20"/> Potential Hazards</h2>
			<table id="hazards">
				<!-- one column table -->
				<tr><td> </td></tr>
			</table>
			<br><br>
		</div>
		<div>
			<h2><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f97d.png?v8" width="20"/> Personal protective equipment</h2>
			<table id="ppe">
				<!-- one column table -->
				<tr><td> </td></tr>
			</table>
			<br><br>
		</div>
		<div>
			<h2><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3ed.png?v8" width="20"/> Where Tasks are to be Undertaken</h2>
			<table id="where">
				<!-- one column table -->
				<tr><td> </td></tr>
			</table>
			<br><br>
		</div>
		<div>
			<h2><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4d6.png?v8" width="20"/> References</h2>
			<table id="references">
				<!-- one column table -->
				<tr><td> </td></tr>
			</table>
			<br><br>
		</div>
		<div>
			<h2><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f9ef.png?v8" width="20"/> Emergency Procedures</h2>
			<table id="emergency">
				<!-- one column table -->
				<tr><td> </td></tr>
			</table>
			<br><br>
		</div>
		<div>
			<h2><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f9f9.png?v8" width="20"/> Clean Up</h2>
			<table id="cleanup">
				<!-- one column table -->
				<tr><td> </td></tr>
			</table>
			<br><br>
		</div>
		<div>	
			<h2><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f5d1.png?v8" width="20"/> Waste Disposal</h2>
			<table id="waste">
				<!-- one column table -->
				<tr><td> </td></tr>
			</table>
			<br><br>
		</div>
		<div>	
			<h2><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f527.png?v8" width="20"/> Maintenance</h2>
			<table id="maintenance">
				<!-- one column table -->
				<tr><td> </td></tr>
			</table>
			<br><br>
		</div>
		<div>
			<h2><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6a5.png?v8" width="20" class="rotate-image"/> Before You Start Work</h2>
			<table id="before_starting">
				<!-- one column table -->
				<tr><td> </td></tr>
			</table>
			<br><br>
		</div>
		<div id="calculator">

		</div>
		<div>
			<h2><img src="https://github.githubassets.com/images/icons/emoji/unicode/25b6.png?v8" width="20"/> Step by Step Procedures</h2>
			<table id="procedures">
				<!-- two column table -->
				<tr><td> </td><td> </td></tr>
				
			</table>
			<br><br>
		</div>
		<div>
			<!-- add section to commit an SOP to LabKey -->
		</div>
	</body>
	<foot>
		<script type="text/javascript">
			window.onload = run((location.search).replace("?",""));
			async function* makeTextFileLineIterator(fileURL) {
				const response = await fetch(fileURL);
				if (!response.ok) {
					throw new Error(`Response status: ${response.status}`);
				}
				const reader = response.body.pipeThrough(new TextDecoderStream()).getReader();
				let { value: chunk, done: readerDone } = await reader.read();
				chunk = chunk || "";
				const newsection = /### /gm;
				let startIndex = 0;
				let result;
				while (true) {
					const result = newsection.exec(chunk);
					if (!result) {
							if (readerDone) break;
							const remainder = chunk.substr(startIndex);
							({ value: chunk, done: readerDone } = await reader.read());
							chunk = remainder + (chunk || "");
							startIndex = newsection.lastIndex = 0;
							continue;
					}
					yield chunk.substring(startIndex, result.index);
					startIndex = newsection.lastIndex;
				}
				if (startIndex < chunk.length) {
					yield chunk.substring(startIndex);
				}
			}
			async function run(urlOfFile) {
				for await (const section of makeTextFileLineIterator(urlOfFile)) {
					processLine(section);
				}
			}
			function processLine(section) {
				let [first, ...rest] = section.split('\n');
				console.log(first)
				console.log(rest)
				if(first === "protocol") {
					for(i=0; i<rest.length; i++) {
						if(rest[i] !== "") {
							line_parts = rest[i].split(":");
							var row = document.getElementById(first).insertRow(i+1);
							var cell0 = row.insertCell(0);
							var cell1 = row.insertCell(1);
							cell0.innerHTML = line_parts[0].replace("- ","");
							cell1.innerHTML = line_parts[1];
						}
					}
				}
				else if(first === "procedures") {
					for(i=0; i<rest.length; i++) {
						var line = rest[i];
						//console.log(`${i}`)
						//console.log(`${line}`)
						if(line !== "") {
							var row = document.getElementById(first).insertRow(i+1);
							var cell0 = row.insertCell(0);
							var cell1 = row.insertCell(1);
							cell0.innerHTML = "<input type=\"checkbox\" id=\"proc`${i}`\" name=\"proc`${i}`\"><label for=\"proc`${i}`\"> " + line + " </label>";
							cell1.innerHTML = "<input type=\"text\" width=\"80px\" placeholder=\"notes\">";
						}
					}
				}
				else if(first === "calculator") {
					rest = rest.join('\n').replace(/~~~~/g,"");
					document.getElementById(first).innerHTML += rest;
				}
				else {
					for(i=0; i<rest.length; i++) {
						if(rest[i] !== "") {
							var row = document.getElementById(first).insertRow(i+1);
							var cell = row.insertCell(0);
							cell.innerHTML = rest[i].replace(/^- /,"");
						}
					}
				}
			}
			
		</script>
	</foot>
</html>
